name: Merge PR

on:
    pull_request:
        types:
            - closed
            - synchronize
        branches:
            - main

concurrency:
    group: merge
    cancel-in-progress: false

jobs:
    merge-aarch64-darwin:
        name: Publish aarch64-darwin
        runs-on: macos-14
        #if: github.event.pull_request.merged == true

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup GCP
              id: gcp
              uses: hoprnet/hopr-workflows/actions/setup-gcp@master
              with:
                  google-credentials: ${{ secrets.GOOGLE_HOPRASSOCIATION_CREDENTIALS_REGISTRY }}
                  install-sdk: 'true'

            - name: Install Nix
              uses: cachix/install-nix-action@v29
              with:
                  github_access_token: ${{ secrets.GITHUB_TOKEN }}
                  nix_path: nixpkgs=channel:nixos-24.05

            - uses: cachix/cachix-action@v15
              with:
                  name: hoprnet
                  authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
              env:
                  USER: runner

            - name: Build
              run: echo nix build .#gnosisvpn-aarch64-darwin -L && mkdir -p results/bin && echo "Dummy content" > results/bin/gnosis-vpn && echo "Dummy content" > results/bin/gnosis-vpn-ctl

            - name: Publish binary
              id: publish-binary
              run: |
                pr_version=$(grep -E '^version\s*=' Cargo.toml | awk -F\" '{print $2}')-pr.${{ github.event.pull_request.number }}
                echo "pr_version=$pr_version" >> ·GITHUB_OUTPUT
                gcloud artifacts generic upload --repository="rust-binaries" --location="europe-west3" --source=results/bin/gnosis-vpn     --path="${{ github.repository }}/${pr_version}/aarch64-darwin/gnosis-vpn"
                gcloud artifacts generic upload --repository="rust-binaries" --location="europe-west3" --source=results/bin/gnosis-vpn-ctl --path="${{ github.repository }}/${pr_version}/aarch64-darwin/gnosis-vpn-ctl"
                gcloud artifacts generic upload --repository="rust-binaries" --location="europe-west3" --source=results/bin/gnosis-vpn     --path="${{ github.repository }}/latest/aarch64-darwin/gnosis-vpn"
                gcloud artifacts generic upload --repository="rust-binaries" --location="europe-west3" --source=results/bin/gnosis-vpn-ctl --path="${{ github.repository }}/latest/aarch64-darwin/gnosis-vpn-ctl"

            - name: Create comment
              uses: peter-evans/create-or-update-comment@v4
              with:
                issue-number: ${{ github.event.pull_request.number }}
                body: |
                    The aarch64-darwin binaries for this PR can be downloaded from:
                    - [Gnosis VPN](https://europe-west3-artifactregistry.googleapis.com/v1/projects/hoprassociation/locations/europe-west3/repositories/rust-binaries/files/${{ github.repository }}/${{ steps.publish-binary.outputs.pr_version}}/aarch64-darwin/gnosis-vpn)
                    - [Gnosis VPN CTL](https://europe-west3-artifactregistry.googleapis.com/v1/projects/hoprassociation/locations/europe-west3/repositories/rust-binaries/files/${{ github.repository }}/${{ steps.publish-binary.outputs.pr_version}}/aarch64-darwin/gnosis-vpn-ctl)

    merge-x86_64-darwin:
        name: Publish x86_64-darwin
        runs-on: macos-13
        #if: github.event.pull_request.merged == true

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup GCP
              id: gcp
              uses: hoprnet/hopr-workflows/actions/setup-gcp@master
              with:
                  google-credentials: ${{ secrets.GOOGLE_HOPRASSOCIATION_CREDENTIALS_REGISTRY }}
                  install-sdk: 'true'

            - name: Install Nix
              uses: cachix/install-nix-action@v29
              with:
                  github_access_token: ${{ secrets.GITHUB_TOKEN }}
                  nix_path: nixpkgs=channel:nixos-24.05

            - uses: cachix/cachix-action@v15
              with:
                  name: hoprnet
                  authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
              env:
                  USER: runner

            - name: Build
              run: echo nix build .#gnosisvpn-x86_64-darwin -L && mkdir -p results/bin && echo "Dummy content" > results/bin/gnosis-vpn && echo "Dummy content" > results/bin/gnosis-vpn-ctl

            - name: Publish binary
              id: publish-binary
              run: |
                pr_version=$(grep -E '^version\s*=' Cargo.toml | awk -F\" '{print $2}')-pr.${{ github.event.pull_request.number }}
                echo "pr_version=$pr_version" >> ·GITHUB_OUTPUT
                gcloud artifacts generic upload --repository="rust-binaries" --location="europe-west3" --source=results/bin/gnosis-vpn     --path="${{ github.repository }}/${pr_version}/x86_64-darwin/gnosis-vpn"
                gcloud artifacts generic upload --repository="rust-binaries" --location="europe-west3" --source=results/bin/gnosis-vpn-ctl --path="${{ github.repository }}/${pr_version}/x86_64-darwin/gnosis-vpn-ctl" 
                gcloud artifacts generic upload --repository="rust-binaries" --location="europe-west3" --source=results/bin/gnosis-vpn     --path="${{ github.repository }}/latest/x86_64-darwin/gnosis-vpn"
                gcloud artifacts generic upload --repository="rust-binaries" --location="europe-west3" --source=results/bin/gnosis-vpn-ctl --path="${{ github.repository }}/latest/x86_64-darwin/gnosis-vpn-ctl"

            - name: Create comment
              uses: peter-evans/create-or-update-comment@v4
              with:
                issue-number: ${{ github.event.pull_request.number }}
                body: |
                    The x86_64-darwin binaries for this PR can be downloaded from:
                    - [Gnosis VPN](https://europe-west3-artifactregistry.googleapis.com/v1/projects/hoprassociation/locations/europe-west3/repositories/rust-binaries/files/${{ github.repository }}/${{ steps.publish-binary.outputs.pr_version}}/x86_64-darwin/gnosis-vpn)
                    - [Gnosis VPN CTL](https://europe-west3-artifactregistry.googleapis.com/v1/projects/hoprassociation/locations/europe-west3/repositories/rust-binaries/files/${{ github.repository }}/${{ steps.publish-binary.outputs.pr_version}}/x86_64-darwin/gnosis-vpn-ctl)

    merge-linux:
        name: Publish ${{ matrix.architecture }}
        runs-on: self-hosted-hoprnet-bigger
        strategy:
            matrix:
                architecture:
                    - x86_64-linux
                    - aarch64-linux
                    - armv7l-linux
        #if: github.event.pull_request.merged == true

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup GCP
              id: gcp
              uses: hoprnet/hopr-workflows/actions/setup-gcp@master
              with:
                  google-credentials: ${{ secrets.GOOGLE_HOPRASSOCIATION_CREDENTIALS_REGISTRY }}
                  install-sdk: 'true'

            - name: Build
              run: nix build .#gnosisvpn-${{ matrix.architecture }} -L

            - name: Publish binary
              id: publish-binary
              run: |
                pr_version=$(grep -E '^version\s*=' Cargo.toml | awk -F\" '{print $2}')-pr.${{ github.event.pull_request.number }}
                echo "pr_version=$pr_version" >> ·GITHUB_OUTPUT
                gcloud artifacts generic upload --repository="rust-binaries" --location="europe-west3" --source=results/bin/gnosis-vpn     --path="${{ github.repository }}/${pr_version}/${{ matrix.architecture }}/gnosis-vpn"
                gcloud artifacts generic upload --repository="rust-binaries" --location="europe-west3" --source=results/bin/gnosis-vpn-ctl --path="${{ github.repository }}/${pr_version}/${{ matrix.architecture }}/gnosis-vpn-ctl" 
                gcloud artifacts generic upload --repository="rust-binaries" --location="europe-west3" --source=results/bin/gnosis-vpn     --path="${{ github.repository }}/latest/${{ matrix.architecture }}/gnosis-vpn"
                gcloud artifacts generic upload --repository="rust-binaries" --location="europe-west3" --source=results/bin/gnosis-vpn-ctl --path="${{ github.repository }}/latest/${{ matrix.architecture }}/gnosis-vpn-ctl"

            - name: Create comment
              uses: peter-evans/create-or-update-comment@v4
              with:
                issue-number: ${{ github.event.pull_request.number }}
                body: |
                    The ${{ matrix.architecture }} binaries for this PR can be downloaded from:
                    - [Gnosis VPN](https://europe-west3-artifactregistry.googleapis.com/v1/projects/hoprassociation/locations/europe-west3/repositories/rust-binaries/files/${{ github.repository }}/${{ steps.publish-binary.outputs.pr_version}}/${{ matrix.architecture }}/gnosis-vpn)
                    - [Gnosis VPN CTL](https://europe-west3-artifactregistry.googleapis.com/v1/projects/hoprassociation/locations/europe-west3/repositories/rust-binaries/files/${{ github.repository }}/${{ steps.publish-binary.outputs.pr_version}}/${{ matrix.architecture }}/gnosis-vpn-ctl)
